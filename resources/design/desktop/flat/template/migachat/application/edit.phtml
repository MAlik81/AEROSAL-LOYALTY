<?php
    try {
        $application  = $this->getApplication();
        $appId        = $application->getId();
        $app_id       = $application->getId();
        $option_value = $this->getOptionValue();
        $value_id     = $option_value->getId();

    // app chatbot settings
        $chatbot_setting_obj = new Migachat_Model_ChatbotSettings();
        $chatbot_setting_obj->find([
            'value_id' => $value_id,
        ]);

        $app_setting_obj = new Migachat_Model_PromptSettings();
        $app_setting_obj->find([
            'value_id' => $value_id,
        ]);

        $system_prompt_precentage = ($chatbot_setting_obj->getId()) ? $chatbot_setting_obj->getSystemPromptTokens() : 80;
    // getting the gpt models
        $gpt_models = [];
        if ($chatbot_setting_obj->getData()) {
            if ($chatbot_setting_obj->getApiType() == 'chatgpt') {
                $apiUrl          = 'https://api.openai.com/v1/models';
                $secret_key      = $chatbot_setting_obj->getSecretKey();
                $organization_id = $chatbot_setting_obj->getOrganizationId();
                $chatAPI         = new Migachat_Model_ChatGPTAPI($apiUrl, $secret_key, $organization_id, 'gpt-4o-mini');
                $gpt_models      = $chatAPI->getModels();

                $assistants_gpt_api = new Migachat_Model_AssistantsGPTAPI($secret_key, $organization_id);
                $all_assistants = $assistants_gpt_api->getAllAssistants();
                
                (new Migachat_Model_Assistants())->updateAssistants($all_assistants, $value_id,$app_id);
            }
        }

        $k8                    = ['gpt-4', 'gpt-4-0613', 'gpt-4-0314', 'code-davinci-002'];
        $k16                   = ['gpt-3.5-turbo-16k', 'gpt-3.5-turbo-16k-0613'];
        $k32                   = ['gpt-4-32k', 'gpt-4-32k-0613', 'gpt-4-32k-0314', 'code-davinci-002'];
        $k128                  = ['gpt-4o-mini', 'gpt-4-vision-preview', 'chatgpt-4o-latest', 'gpt-4o-mini-2024-07-18', 'gpt-4o-2024-08-06', 'gpt-4o-2024-05-13', 'gpt-4o'];
        $total_tokens          = 0;
        $model_limit           = [];
        $gpt_models_with_limit = [];
        $openai                = ['openai-dev', 'openai', 'openai-internal', 'system'];
        foreach ($gpt_models as $key => $value) {

            $tokens_obj = new Migachat_Model_ModelTokens();
            $tokens     = $tokens_obj->find([
                'model_name' => $value['id'],
            ]);
            $limit = 0;

            if ($tokens->getId()) {
                $limit = $tokens->getTokens();
            } else {
                if (in_array($value['id'], $k8)) {
                    $limit = 8000;
                } elseif (in_array($value['id'], $k16)) {
                    $limit = 16000;
                } elseif (in_array($value['id'], $k32)) {
                    $limit = 32000;
                } elseif (in_array($value['id'], $k128)) {
                    $limit = 128000;
                } else {
                    $limit = 4000;
                }
            }
            if (! in_array($value['owned_by'], $openai)) {
                $model_limit[$value['id']] = $limit;
            }
            $gpt_models_with_limit[$value['id']] = $value['id'] . ' (' . $limit . ' TOKENS)';

            if ($app_setting_obj->getId() && $app_setting_obj->getGptModel() == $value['id']) {
                $total_tokens = $limit - 500;
            }

        }

        $users_with_chat = (new Migachat_Model_Chatlogs())->getUserIdsWithChat($value_id);
        function generateRandomString($length = 20)
        {
            $characters   = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            $randomString = '';
            $max          = strlen($characters) - 1;

            for ($i = 0; $i < $length; $i++) {
                $randomString .= $characters[random_int(0, $max)];
            }

            return $randomString;
        }

        $bridge_obj = new Migachat_Model_BridgeAPISettings();
        $bridge_obj->find([
            'value_id' => $value_id,
        ]);

        $bridge_logs_obj = new Migachat_Model_BridgeAPI();
    // $chat_ids = $bridge_logs_obj->getAllChatIds($value_id);
        $operator_requests = (new Migachat_Model_OperatorRequests)->findAll(['value_id' => $value_id], "migachat_operator_request_id DESC")->toArray();
        $chat_ids          = (new Migachat_Model_ModelChatIds())->findAll(['value_id' => $value_id], "chat_id ASC")->toArray();
        // print_r($chat_ids);
    // usort($chat_ids, fn($a, $b) => $a['chat_id'] <=> $b['chat_id']);
    // Usage
        $randomBridgeString = generateRandomString();
        if (! $bridge_obj->getId() || ! $bridge_obj->getAuthToken()) {

            $bridge_obj_data               = [];
            $bridge_obj_data['value_id']   = $value_id;
            $bridge_obj_data['auth_token'] = $randomBridgeString;
            $bridge_obj_data['created_at'] = date("Y-m-d H:i:s");
            $bridge_obj_data['updated_at'] = date("Y-m-d H:i:s");
            $bridge_obj->addData($bridge_obj_data)->save();
            $bridge_obj->find([
                'value_id' => $value_id,
            ]);
        }

        $web_services_logs = (new Migachat_Model_Webservicelogs)->getLastNRecords($value_id, 30);
        $new_messages_push = (new Migachat_Model_Cron())->newMessagesPushLogs($value_id);

    // getting gdpr settings
        $gdpr_settings = (new Migachat_Model_GDPR)->find(['value_id' => $value_id]);

    // $operator_settings defaults
        $default_email_subject  = 'Cliente richiede di essere contattato da chat su chatbot AI';
        $default_email_template = <<<EOT
Ciao Admin,

abbiamo ricevuto una richiesta di contatto da un utente durante una conversazione sulla nostra chat AI.
Qui i dettagli di riferimento:

APP ID: @@app_id@@
NOME APP: @@app_name@@
ID Istanza: @@instance_id@@
Nome Utente: @@user_name@@
Mail Utente: @@user_email@@
Telefono Utente: @@user_mobile@@
Chat ID: @@chat_id@@
Tipo Chat: @@chat_type@@
ID Richiesta: @@operator_request_id@@
Data Richiesta: @@date_time@@
Ecco le ultime 5 interazioni sulla chat prima della richiesta: @@last_five_history@@

Procedi con il contattare il prospect quanto prima.
Grazie ADMIN
EOT;

        $default_operator_prompt       = 'Analyze this text string that a user wrote on our support chat (user prompt), reply with 1 if it is sufficiently probable tha it means that the user wants to speak to an operator. If it is not clear enough and in all other cases reply with a 0';
        $default_ask_call_message      = 'Do you want me to have one of our operators call you? (Type Yes or No)';
        $default_confirm_call_message  = 'Perfect, I warned my colleagues, they will be in touch very soon. Now you can continue to ask me for information if you want.';
        $default_invalid_call_message  = 'Perfect, I warned my colleagues, they will be in touch very soon. Now you can continue to ask me for information if you want.';
        $default_declined_call_message = 'From what I understand you are not interested in a call from one of our operators. We can continue to chat about other things if you want.';
        $default_operator_language     = 'it';

    // $operator_settings
        $operator_settings = (new Migachat_Model_OperatorSettings)->find(['value_id' => $value_id]);

        if (! $operator_settings->getId()) {
            $operator_defaults = [
                'app_id'            => $app_id,
                'value_id'          => $value_id,
                'is_enabled_in_app' => 0,
                'is_enabled_bridge_api' => 1,
                'operator_system_prompt' => $default_operator_prompt,
                'ask_call_from_operator_msg' => $default_ask_call_message,
                'confirm_call_from_operator_msg' => $default_confirm_call_message,
                'invalid_ask_call_from_operator_msg' => $default_invalid_call_message,
                'declined_call_from_operator_msg' => $default_declined_call_message,
                'default_language'  => $default_operator_language,
                'email_subject'     => $default_email_subject,
                'email_template'    => $default_email_template,
                'created_at'        => date('Y-m-d H:i:s'),
                'updated_at'        => date('Y-m-d H:i:s'),
            ];

            try {
                $operator_settings->addData($operator_defaults)->save();
            } catch (Exception $e) {
            }

            $operator_settings->find(['value_id' => $value_id]);
        }

        $is_enabled_in_app = $operator_settings->getIsEnabledInApp();
        $is_enabled_in_app = ($is_enabled_in_app === null || $is_enabled_in_app === '') ? '1' : (string) $is_enabled_in_app;

        $is_enabled_bridge_api = $operator_settings->getIsEnabledBridgeApi();
        $is_enabled_bridge_api = ($is_enabled_bridge_api === null || $is_enabled_bridge_api === '') ? '0' : (string) $is_enabled_bridge_api;

        $operator_language_value         = $operator_settings->getDefaultLanguage() ? $operator_settings->getDefaultLanguage() : $default_operator_language;
        $email_subject_value             = $operator_settings->getEmailSubject() ? $operator_settings->getEmailSubject() : $default_email_subject;
        $email_template_value            = $operator_settings->getEmailTemplate() ? $operator_settings->getEmailTemplate() : $default_email_template;
        $operator_system_prompt_value    = $operator_settings->getOperatorSystemPrompt() ? $operator_settings->getOperatorSystemPrompt() : $default_operator_prompt;
        $ask_call_from_operator_value    = $operator_settings->getAskCallFromOperatorMsg() ? $operator_settings->getAskCallFromOperatorMsg() : $default_ask_call_message;
        $confirm_call_from_operator_val  = $operator_settings->getConfirmCallFromOperatorMsg() ? $operator_settings->getConfirmCallFromOperatorMsg() : $default_confirm_call_message;
        $invalid_call_from_operator_val  = $operator_settings->getInvalidAskCallFromOperatorMsg() ? $operator_settings->getInvalidAskCallFromOperatorMsg() : $default_invalid_call_message;
        $declined_call_from_operator_val = $operator_settings->getDeclinedCallFromOperatorMsg() ? $operator_settings->getDeclinedCallFromOperatorMsg() : $default_declined_call_message;

        $assistants = (new Migachat_Model_Assistants())->findAll(['value_id' => $value_id])->toArray();

    // licenses settings start
        $main_domain = __get('main_domain');
        if (! preg_match("~^(?:f|ht)tps?://~i", $main_domain)) {
            // If not exist then add http
            $main_domain = "https://" . $main_domain;
        }
        $curlSession = curl_init();
        curl_setopt($curlSession, CURLOPT_URL, $main_domain . '/migachat/public_license/validateapplicense?app_id=' . $app_id . '&instance_id=' . $value_id); //every module that can be added to the app more than once now needs to pass the value id as well to the license server e.g. instance_id='.$option->getId()
        curl_setopt($curlSession, CURLOPT_BINARYTRANSFER, true);
        curl_setopt($curlSession, CURLOPT_RETURNTRANSFER, true);
        $jsonDataString = curl_exec($curlSession);
        curl_close($curlSession);
        $license = Siberian_Json::decode($jsonDataString);
    // licenses settings end

    ?>

<style>
    #api_chat_archive_ai_on {
        background-color: #4CAF50;
        color: #fff;
        padding: 6px 12px;
        border-radius: 4px !important;
    }

    #api_chat_archive_ai_off {
        background-color: #f44336;
        color: #fff;
        padding: 6px 12px;
        border-radius: 4px !important;
    }

    #api_chat_archive_limit_off {
        background-color: #f44336;
        color: #fff;
        padding: 6px 12px;
        border-radius: 4px !important;
    }

 .button-list {
    list-style: none; /* Remove bullets */
    padding: 0;
    margin: 0;
    margin-top: 10px;
    display: flex; /* Align items inline */
    gap: 10px; /* Add space between items */
  }

  .button-list li {
    display: inline; /* Ensure items are inline */
  }
</style>
<?php

    if ($license['success_message']) {?>
<?php if (! $license['is_platform']) {?>
        <div class="alert alert-success">
            <?php echo $license['success_message']; ?>
        </div>
    <?php }

                $setting = new Migachat_Model_Setting();
            ?>
    <p>
        <a href="<?php echo ! empty($setting->getHelpUrl()) ? $setting->getHelpUrl() : 'https://www.migastone.eu/migachat'; ?>"
            target="_blank" class="link-help color-blue btn">
            <i class="fa fa-question-circle"></i>
        </a>

        <a href="#" class="link-help color-blue btn">
        1.3.31
        </a>
    </p>

    <?php
        if (! $app_setting_obj->getId()) {
                ?>
        <div class="alert alert-warning">
            <?php echo p__("Migachat", 'Please save the Settings first before. Otherwise chatbot will not work.') ?>
            <a href="#settings" aria-controls="settings" role="tab" data-toggle="tab" class="button button-calm">
                <?php echo p__("Migachat", 'Settings') ?>
            </a>
        </div>
        <?php
            }
                ?>
    <div class="edit_page fidelity">
        <div id="fidelity_tabs">
            <div id="list" class="migachat_tabs">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#app_chat_archive" aria-controls="app_chat_archive" role="tab" data-toggle="tab">
                            <i class="fa fa-certificate"></i>
                            <?php echo p__("Migachat", 'APP Chat Archives') ?>
                        </a>
                    </li>
                    <li role="presentation">
                        <a href="#api_chat_archive" aria-controls="api_chat_archive" role="tab" data-toggle="tab">
                            <i class="fa fa-comments-o"></i>
                            <?php echo p__("Migachat", 'API Chat Archives') ?>
                        </a>
                    </li>
                    <li role="presentation">
                        <a href="#push_logs" aria-controls="push_logs" role="tab" data-toggle="tab">
                            <i class="fa fa-list"></i>
                            <?php echo p__("Migachat", 'Logs') ?>
                        </a>
                    </li>
                    <li role="presentation">
                        <a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">
                            <i class="fa fa-cog"></i>
                            <?php echo p__("Migachat", 'Settings') ?>
                        </a>
                    </li>
                    <li role="presentation">
                        <a href="#gdpr_settings" aria-controls="gdpr_settings" role="tab" data-toggle="tab">
                            <i class="fa fa-cog"></i>
                            <?php echo p__("Migachat", 'GDPR Settings') ?>
                        </a>
                    </li>
                    <li role="presentation">
                        <a href="#operator_settings" aria-controls="operator_settings" role="tab" data-toggle="tab">
                            <i class="fa fa-cog"></i>
                            <?php echo p__("Migachat", 'Operator Settings') ?>
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- START apis_config TAB -->
                    <div role="tabpanel" class="tab-pane active" id="app_chat_archive">
                        <div class="content">
                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'APP Chat Stats & Export'); ?>
                                <button class="button btn btn color-red pull-right" style="margin-top: -5px;"
                                    id="delete_app_chat_archive"><?php echo p__("Migachat", 'Delete All Chats History');?></button>
                            </h3>

                            <div class="container-fluid subcontent content-feature">
                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <div class="col-md-3">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'From Last Interaction Date Range')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" class="input-flat" id="app-chat-date-from"  value=<?php echo date("Y-m-d", strtotime("-30 days", strtotime('now')))?>">
                                        </div>

                                        <div class="col-md-1">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'To')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" class="input-flat" id="app-chat-date-to"  value="<?php echo date('Y-m-dt')?>">
                                        </div>

                                        <div class="col-md-2">
                                            <button class="button btn btn color-blue" id="filter_app_chat_stats">
                                                <?php echo p__("Migachat", 'Filter Stats'); ?>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-1" style="padding:0px;text-align:right;">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Total Chats')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-2" style="padding-right:0px;">
                                            <input type="text" disabled class="input-flat" id="app-chat-total-chats">
                                        </div>

                                        <div class="col-md-2" style="padding:0px;text-align:right;">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Total Prompt Tokens')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-2" style="padding-right:0px;">
                                            <input type="text" disabled class="input-flat" id="app-chat-prompt-tokens">
                                        </div>
                                        <div class="col-md-3" style="padding:0px;text-align:right;">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Total Completion Tokens')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="text" disabled class="input-flat" id="app-chat-completion-tokens">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-3">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Chat related to date filter')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="button btn btn color-blue" id="download_app_chat_stats_csv">
                                                <?php echo p__("Migachat", 'EXPORT CSV'); ?>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- end app stats -->
                        <!-- start app chat archive -->
                        <div class="content">

                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'APP Chat Archive Search'); ?>
                            </h3>

                            <div class="container-fluid subcontent content-feature">
                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'APP user Name, Email or Phone')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-4">

                                            <select class="color-blue  input-flat select2" name="app_chat_archive_filter"
                                                id="app_chat_archive_filter">
                                                <option value="">
                                                    <?php echo p__("Migachat", 'Select Customer');?>
                                                </option>
                                                <?php foreach ($users_with_chat as $key => $value) {
                                                                $customer_obj = [];
                                                                $customer_obj = new Customer_Model_Customer();
                                                                $customer_obj->find($value['customer_id']);
                                                            ?>
                                                    <option value="<?php echo $value['customer_id']?>">
                                                        <?php echo $customer_obj->getId() . ', ' . $customer_obj->getFirstname() . ' ' . $customer_obj->getLastname() . ', ' . $customer_obj->getEmail() . ', ' . $customer_obj->getMobile()?>
                                                    </option>
                                                <?php }?>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-3">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'From Last Interaction Date Range')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date"
                                                value="<?php echo date("Y-m-d", strtotime("-30 days", strtotime('now')))?>"
                                                class="input-flat" id="app_chat_archive_datefrom">
                                        </div>


                                        <div class="col-md-1">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'To')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" value="<?php echo date("Y-m-d")?>" class="input-flat"
                                                id="app_chat_archive_dateto">
                                        </div>

                                        <div class="col-md-2">
                                            <button class="button btn btn color-blue" id="app_chat_archive_search">
                                                <?php echo p__("Migachat", 'SEARCH'); ?>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <hr />
                            <div class="container-fluid content-feature pt30">

                                <p class="title-editor no-border-radius border-blue">
                                    <strong><?php echo p__("Migachat", 'USER NAME'); ?>:</strong> <span
                                        id="app_chat_archive_user_name"></span> /
                                    <strong><?php echo p__("Migachat", 'USER EMAIL'); ?>:</strong> <span
                                        id="app_chat_archive_user_email"></span>
                                    <strong><?php echo p__("Migachat", 'USER PHONE'); ?>:</strong> <span
                                        id="app_chat_archive_user_mobile"></span>

                                </p>
                                <p class="title-editor no-border-radius">
                                    <button class="button btn btn-danger btn-xs delete_chat_history">
                                        <?php echo p__("Migachat", 'Delete customer chat history'); ?>
                                    </button>
                                    <button class="button btn btn-xs color-blue" id="app_chat_archive_table_csv">
                                        <?php echo p__("Migachat", 'Download Csv'); ?>
                                    </button>

                                </p>
                                <div style="max-height:500px;overflow:scroll;">
                                    <table id="app_chat_archive_table" style="width:100%;"
                                        class="table table-bordered content-white-bkg margin-top">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <?php echo p__("Migachat", "Time Stamp")?>
                                                </th>
                                                <th>
                                                    <?php echo p__("Migachat", "Role")?>
                                                </th>
                                                <th>
                                                    <?php echo p__("Migachat", "Message")?>
                                                </th>
                                                <th>
                                                    <?php echo p__("Migachat", "Tokens")?>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="app_chat_archive_table_body">

                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- START chat_archive TAB -->
                    <div role="tabpanel" class="tab-pane" id="api_chat_archive">
                        <div class="content">
                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'API Chats CSV Import'); ?>
                            </h3>

                            <div class="container-fluid subcontent content-feature">
                                <form method="POST" action="<?php echo $this->getUrl('migachat/bridgeapi/importapicsvchats') ?>" id="api_chat_csv_form">
                                    <div class="form-horizontal">
                                        <div class="form-group">
                                            <div class="col-md-3">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'Select CSV to import')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-7">
                                                <input type="hidden" name="value_id" value="<?php echo $value_id?>">
                                                <input type="file" id="api_chat_csv_file" name="api_chat_csv_file" accept=".csv" required>
                                            </div>
                                            <div class="col-md-2">
                                                <button class="button btn btn color-blue" type="submit" id="import_csv_api_chat">
                                                    <?php echo p__("Migachat", 'Import CSV'); ?>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- end api stats -->
                        <div class="content">
                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'API Chat Stats & Export'); ?>
                                <button class="button btn btn color-red pull-right" style="margin-top: -5px;"
                                    id="delete_api_chat_archive"><?php echo p__("Migachat", 'Delete All Chats History');?></button>
                            </h3>

                            <div class="container-fluid subcontent content-feature">
                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <div class="col-md-3">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'From Last Interaction Date Range')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" class="input-flat" id="api_chat-date-from" value="<?php echo date("Y-m-d", strtotime("-30 days", strtotime('now')))?>">
                                        </div>

                                        <div class="col-md-1">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'To')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" class="input-flat" id="api_chat-date-to" value="<?php echo date('Y-m-d')?>">
                                        </div>

                                        <div class="col-md-2">
                                            <button class="button btn btn color-blue" id="filter_api_chat_stats">
                                                <?php echo p__("Migachat", 'Filter Stats'); ?>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-1" style="padding:0px;text-align:right;">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Total Chats')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-2" style="padding-right:0px;">
                                            <input type="text" disabled class="input-flat" id="api_chat-total-chats">
                                        </div>

                                        <div class="col-md-2" style="padding:0px;text-align:right;">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Total Prompt Tokens')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-2" style="padding-right:0px;">
                                            <input type="text" disabled class="input-flat" id="api-chat-prompt-tokens">
                                        </div>
                                        <div class="col-md-3" style="padding:0px;text-align:right;">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Total Completion Tokens')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="text" disabled class="input-flat" id="api-chat-completion-tokens">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-3">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Chat related to date filter')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="button btn btn color-blue" id="download_api_chat_stats_csv">
                                                <?php echo p__("Migachat", 'EXPORT CSV'); ?>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- end api stats -->
                        <!-- start api chat archive -->
                        <div class="content">

                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'API Chat Archive Search'); ?>

                            </h3>

                            <div class="container-fluid subcontent content-feature">
                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Chat ID, user Name, Email or Phone')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <!-- <input type="text" class="input-flat" id="api_chat_archive_filter"> -->
                                            <select class="color-blue  input-flat select2" name="api_chat_archive_filter"
                                                id="api_chat_archive_filter">
                                                <option value="">
                                                    <?php echo p__("Migachat", 'Select Chat ID');?>
                                                </option>
                                                <?php foreach ($chat_ids as $key => $value) {
                                                                if ($value['user_name'] || $value['user_email'] || $value['user_mobile']) {
                                                                ?>
                                                        <option value="<?php echo $value['chat_id']?>"> <?php echo $value['chat_id']?>
                                                            <?php echo $value['user_name']?>             <?php echo $value['user_email']?>
                                                            <?php echo $value['user_mobile']?>
                                                        </option>
                                                        <?php
                                                            }
                                                                }?>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-3">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'From Last Interaction Date Range')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" class="input-flat" id="api_chat_archive_datefrom" value="<?php echo date("Y-m-d", strtotime("-30 days", strtotime('now')))?>">
                                        </div>

                                        <div class="col-md-1">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'To')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" class="input-flat" id="api_chat_archive_dateto"  value="<?php echo date('Y-m-d')?>">
                                        </div>

                                        <div class="col-md-2">
                                            <button class="button btn btn color-blue" id="api_chat_archive_search">
                                                <?php echo p__("Migachat", 'SEARCH'); ?>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <hr />
                            <div class="container-fluid content-feature pt30">

                                <h5 class="title-editor no-border-radius border-blue">
                                    <?php echo p__("Migachat", 'Chat Id'); ?>: <span id="api_chat_archive_chat_id"></span>
                                    <?php echo p__("Migachat", 'USER NAME'); ?>: <span
                                        id="api_chat_archive_user_name"></span>
                                    <?php echo p__("Migachat", 'USER EMAIL'); ?>: <span
                                        id="api_chat_archive_user_email"></span>
                                    <?php echo p__("Migachat", 'USER PHONE'); ?>: <span
                                        id="api_chat_archive_user_mobile"></span>

                                </h5>
                                <ul class="button-list">
                                    <li>
                                        <span id="api_chat_archive_ai_on" class="button btn btn-success color-green"><?php echo p__("Migachat", 'AI is enabled'); ?></span>
                                        <span id="api_chat_archive_ai_off" class="button btn btn-danger color-red" style="display:none;"><?php echo p__("Migachat", 'AI is disabled'); ?></span>
                                    </li>
                                    <li>
                                        <span id="api_chat_archive_limit_off" class="button btn btn-danger color-red" style="display:none;"><?php echo p__("Migachat", 'Limit is disabled'); ?></span>
                                    </li>
                                    <li>
                                        <span id="temporary_blacklist_msg" class="button btn btn-danger color-red" style="display:none;"><?php echo p__("Migachat", 'Temporary Blacklisted'); ?></span>
                                        <button class="button btn btn-danger color-red"
                                            id="temporary_blacklist_user"  style="display:none;">
                                            <?php echo p__("Migachat", 'Temporary Blacklist'); ?>
                                        </button>
                                        <!-- <button class="button btn color-blue"
                                            id="remove_blacklist_user">
                                            <?php echo p__("Migachat", 'Undo Temporary Blacklist'); ?>
                                        </button> -->
                                    </li>
                                    <li>
                                        <button class="button btn btn-warning color-orange"
                                            id="delete_bridge_chat_history"  style="display:none;">
                                            <?php echo p__("Migachat", 'Delete Current Chat History'); ?>
                                        </button>
                                    </li>
                                    <li>
                                        <button class="button btn color-blue" id="api_chat_archive_table_csv"  style="display:none;">
                                            <?php echo p__("Migachat", 'Export Csv'); ?>
                                        </button>
                                    <li>
                                </ul>

                                <div style="max-height:500px;overflow:scroll;">
                                    <table id="api_chat_archive_table" style="width:100%;"
                                        class="table content-white-bkg margin-top">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <?php echo p__("Migachat", "Time Stamp")?>
                                                </th>
                                                <th>
                                                    <?php echo p__("Migachat", "Role")?>
                                                </th>
                                                <th>
                                                    <?php echo p__("Migachat", "Message")?>
                                                </th>
                                                <th>
                                                    <?php echo p__("Migachat", "Tokens")?>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="api_chat_archive_table_body">

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- /END chat_archive TAB -->
                    <!-- START push_logs TAB -->
                    <div role="tabpanel" class="tab-pane" id="push_logs">
                        <div class="content">
                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'Last 30 Chat Logs'); ?>
                            </h3>
                            <div class="container-fluid content-feature pt30">
                                <table id="push_logs_table" style="width:100%;" class="table content-white-bkg margin-top">
                                    <thead>
                                        <tr>
                                            <th>
                                                <?php echo p__("Migachat", "Log Id")?>
                                            </th>
                                            <th>
                                                <?php echo p__("Migachat", "Descripiton")?>
                                            </th>
                                            <th>
                                                <?php echo p__("Migachat", "Status")?>
                                            </th>
                                            <th>
                                                <?php echo p__("Migachat", "Platform")?>
                                            </th>
                                            <th>
                                                <?php echo p__("Migachat", "Created At")?>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php foreach ($web_services_logs as $key => $value) {?>
                                            <tr>
                                                <td>
                                                    <?php echo $value['log_id']?>
                                                </td>
                                                <td onclick="getChatLog(<?php echo $value['log_id']?>)">
                                                    <?php echo $value['error_description']?>
                                                </td>
                                                <td>
                                                    <?php echo ($value['has_error']) ? p__("Migachat", "Error") : p__("Migachat", "Success")?>
                                                </td>
                                                <td>
                                                    <?php echo $value['platform']?>
                                                </td>
                                                <td>
                                                    <?php echo $value['created_at']?>
                                                </td>
                                            </tr>
                                        <?php }?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="content">

                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'New received messages push logs'); ?>
                            </h3>
                            <div class="container-fluid content-feature pt30">
                                <table id="received_table" style="width:100%;" class="table content-white-bkg margin-top">
                                    <thead>
                                        <tr>
                                            <th>
                                                <?php echo p__("Migachat", "Message Id")?>
                                            </th>
                                            <th>
                                                <?php echo p__("Migachat", "Message Content")?>
                                            </th>
                                            <th>
                                                <?php echo p__("Migachat", "Customer Id")?>
                                            </th>
                                            <th>
                                                <?php echo p__("Migachat", "Customer Name")?>
                                            </th>
                                            <th>
                                                <?php echo p__("Migachat", "Status")?>
                                            </th>
                                            <th>
                                                <?php echo p__("Migachat", "Created At")?>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php foreach ($new_messages_push as $key => $value) {?>
                                            <tr>
                                                <td>
                                                    <?php echo $value['migachat_chatlog_id']?>
                                                </td>
                                                <td>
                                                    <?php echo $value['message_content']?>
                                                </td>
                                                <td>
                                                    <?php echo $value['customer_id']?>
                                                </td>
                                                <td>
                                                    <?php echo $value['firstname']?>
                                                    <?php echo $value['lastname']?>
                                                </td>
                                                <td>
                                                    <?php echo ($value['status']) ? p__("Migachat", 'Success') : p__("Migachat", 'Fail')?>
                                                </td>
                                                <td>
                                                    <?php echo $value['created_at']?>
                                                </td>
                                            </tr>
                                        <?php }?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- /END push_logs TAB -->
                    <!-- START DESIGN TAB -->
                    <div role="tabpanel" class="tab-pane" id="settings">

                        <!-- Module Config start -->
                        <div class="content">
                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'Module Configuration'); ?>
                            </h3>
                            <div class="container-fluid subcontent content-feature">
                                <form id="api_config_form" method="POST"
                                    action="<?php echo $this->getUrl('migachat/application/apisconfig') ?>">

                                    <input type="hidden" name="value_id" id="value_id" value="<?php echo $value_id; ?>" />
                                    <input type="hidden" name="app_id" id="app_id" value="<?php echo $app_id; ?>" />
                                    <div class="form-horizontal">
                                        <div class="form-group">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'Module Operation')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-4">
                                                <select name="api_type" id="api-type-input"
                                                    class="no-dk styled-select color-blue">
                                                    <option value="chatgpt" <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getApiType() == "chatgpt") ? 'selected' : ''?>>
                                                        <?php echo p__("Migachat", 'Chat Gpt API');?>
                                                    </option>
                                                    <option value="webhook" <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getApiType() == "webhook") ? 'selected' : ''?>>
                                                        <?php echo p__("Migachat", 'Webhook');?>
                                                    </option>
                                                </select>
                                            </div>
                                        </div>


                                        <div id="chat-gpt-inputs" style="">
                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label for="organization-id-input">
                                                        <?php echo p__("Migachat", 'Organization ID');?>:
                                                    </label>
                                                </div>

                                                <div class="col-md-4">
                                                    <input type="text" name="organization_id" id="organization-id-input"
                                                        value="<?php echo ($chatbot_setting_obj->getId()) ? $chatbot_setting_obj->getOrganizationId() : "";?>"
                                                        class="required input-flat">
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label for="secret-key-input">
                                                        <?php echo p__("Migachat", 'Secret Key');?>:
                                                    </label>
                                                </div>

                                                <div class="col-md-4">
                                                    <input type="text" name="secret_key" id="secret-key-input"
                                                        value="<?php echo ($chatbot_setting_obj->getId()) ? $chatbot_setting_obj->getSecretKey() : "";?>"
                                                        class="required input-flat">
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label for="secret-key-input">
                                                        <?php echo p__("Migachat", 'Chat Type');?>:
                                                    </label>
                                                </div>

                                                <div class="col-md-4">
                                                    <select name="use_assistant" id="use_assistant-input"
                                                        class="no-dk styled-select color-blue">
                                                        <option value="1" <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getUseAssistant() == "1") ? 'selected' : ''?>>
                                                            <?php echo p__("Migachat", 'Assistant');?>
                                                        </option>
                                                        <option value="0" <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getUseAssistant() != "1") ? 'selected' : ''?>>
                                                            <?php echo p__("Migachat", 'Simple Chat');?>
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div id="chat-gpt-inputs-2" <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getUseAssistant() == "1") ? 'style="display:none;"' : '';?>>

                                                <!--  -->
                                                <div class="form-group">
                                                    <div class="col-md-4">
                                                        <label for="history_tokens-input">
                                                            <?php echo p__("Migachat", 'History Tokens %');?>:
                                                        </label>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <input type="number" min="0" max="100" name="history_tokens"
                                                            id="history_tokens-input"
                                                            value="<?php echo ($chatbot_setting_obj->getId()) ? $chatbot_setting_obj->getHistoryTokens() : 20;?>"
                                                            class="required input-flat">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-md-4">
                                                        <label for="history_messages-input">
                                                            <?php echo p__("Migachat", 'Max messages in history');?>:
                                                        </label>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <input type="number" min="0" max="50" name="history_messages"
                                                            id="history_messages-input"
                                                            value="<?php echo ($chatbot_setting_obj->getId()) ? $chatbot_setting_obj->getHistoryMessages() : 15;?>"
                                                            class="required input-flat">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-md-4">
                                                        <label for="system_prompt_tokens-input">
                                                            <?php echo p__("Migachat", 'System prompt tokens %');?>:
                                                        </label>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <input type="number" min="0" max="100" name="system_prompt_tokens"
                                                            id="system_prompt_tokens-input"
                                                            value="<?php echo ($chatbot_setting_obj->getId()) ? $chatbot_setting_obj->getSystemPromptTokens() : 80;?>"
                                                            class="required input-flat">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="webhook-inputs" style="display: none;">

                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label for="webhook-url-input">
                                                        <?php echo p__("Migachat", 'Webhook URL');?>:
                                                    </label>
                                                </div>

                                                <div class="col-md-8">
                                                    <input type="text" name="webhook_url" id="webhook-url-input"
                                                        value="<?php echo ($chatbot_setting_obj->getId()) ? $chatbot_setting_obj->getWebhookUrl() : "";?>"
                                                        class="required input-flat">
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label for="webhook-url-input">
                                                        <?php echo p__("Migachat", 'Authentication Token');?>:
                                                    </label>
                                                </div>

                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-primary btn-sm"
                                                        id="generate-auth-token">
                                                        <i class="fa fa-refresh"></i>
                                                    </button>
                                                </div>
                                                <?php
                                                    // Usage
                                                            $randomString = generateRandomString();

                                                        ?>
                                                <div class="col-md-4">
                                                    <input type="text" name="auth_token" id="auth-token"
                                                        value="<?php echo ($chatbot_setting_obj->getId()) ? $chatbot_setting_obj->getAuthToken() : $randomString;?>"
                                                        class="required input-flat">
                                                </div>
                                            </div>
                                            <div class="alert alert-warning">
                                                <?php echo p__("Migachat", 'Following parameters are included in url');?>:
                                                <p>
                                                    <b>
                                                        `customer_id`,`instance_id`,`app_id`,`app_name`,`customer_name`,`customer_mobile`,`customer_email`
                                                    </b>
                                                </p>
                                            </div>
                                            <div class="alert  alert-warning">
                                                <?php echo p__("Migachat", 'The message will be sent json encoded via POST method in the "message" variable instead of query string.');?>
                                            </div>
                                            <div class="alert alert-info">
                                                <?php echo p__("Migachat", 'The webservice link to capture the responce from webhook');?>:
                                                <b>
                                                    <?php echo $main_domain?>/migachat/public_werservice/webservice
                                                </b>
                                            </div>
                                            <div class="alert alert-info">
                                                <?php echo p__("Migachat", 'The webservice request must containt these parameters');?>:
                                                <b>('message','customer_id','customer_email','instance_id','auth_token')</b>
                                            </div>
                                            <div class="alert alert-info">
                                                <?php echo p__("Migachat", 'You can send any one of the ');?>: <b>('customer_id' /
                                                    'customer_email')</b>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="col-md-4">
                                                <label for="organization-id-input">
                                                    <?php echo p__("Migachat", 'App-end input placeholder');?>:
                                                </label>
                                            </div>

                                            <div class="col-md-4">
                                                <input type="text" name="place_holder" id="organization-id-input"
                                                    value="<?php echo ($chatbot_setting_obj->getId()) ? $chatbot_setting_obj->getPlaceHolder() : "Type your message...";?>"
                                                    class="required input-flat">
                                            </div>
                                        </div>

                                        <div class="save pull-right">
                                            <button class="button btn bt_save btn color-blue" type="submit">
                                                <?php echo p__("Migachat", 'Save'); ?>
                                            </button>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>
                        <!-- Module Config end -->
                        <div <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getUseAssistant() == "1") ? 'style="display:none;"' : '';?>>
                            <!-- OpenAi Config Start -->
                            <div class="content">
                                <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                    <?php echo p__("Migachat", 'OpenAI Configuration'); ?>
                                    <input type="hidden" name="token_limit" id="token_limit" value="2000">
                                </h3>
                                <div class="container-fluid subcontent content-feature">
                                    <form id="openai_config" method="POST"
                                        action="<?php echo $this->getUrl('migachat/application/appsettings') ?>">

                                        <input type="hidden" name="value_id" id="value_id" value="<?php echo $value_id; ?>" />
                                        <div class="form-horizontal">
                                            <div class="" <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getApiType() != "chatgpt") ? 'style="display:none;"' : '';?>>
                                                <div class="form-group">
                                                    <div class="col-md-4">
                                                        <label for="select-input">
                                                            <?php echo p__("Migachat", 'Select Model')?>:
                                                        </label>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <select name="gpt_model" id="gpt_model-input"
                                                            class="no-dk styled-select color-blue">
                                                            <option value="" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getGptModel() == "") ? 'selected' : '';?>>
                                                                <?php echo p__("Migachat", 'Select ChatGPT Model');?>
                                                            </option>
                                                            <?php foreach ($gpt_models_with_limit as $key => $value) {
                                                                        ?>
                                                                <option value="<?php echo $key?>" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getGptModel() == $key) ? 'selected' : '';?>>
                                                                    <?php echo $value;?>
                                                                </option>
                                                            <?php }?>

                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                        <div class="save pull-right">
                                            <button class="button btn bt_save btn color-blue" type="submit">
                                                <?php echo p__("Migachat", 'Save'); ?>
                                            </button>
                                        </div>
                                    </form>

                                </div>

                            </div>
                            <!-- openAi config end -->
                            <!-- OpenAi Config Start -->
                            <div class="content">
                                <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                    <?php echo p__("Migachat", 'SYSTEM PROMPT Configuration'); ?>
                                </h3>
                                <div class="container-fluid subcontent content-feature">
                                    <form id="prompt_setting_form" method="POST"
                                        action="<?php echo $this->getUrl('migachat/application/appsettings') ?>">

                                        <input type="hidden" name="value_id" id="value_id" value="<?php echo $value_id; ?>" />
                                        <div class="form-horizontal">
                                            <div class="" <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getApiType() != "chatgpt") ? 'style="display:none;"' : '';?>>
                                                <div class="form-group">
                                                    <div class="col-md-4">
                                                        <label for="select-input">
                                                            <?php echo p__("Migachat", 'System prompt For ChatGPT')?>:
                                                        </label>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <select name="prompt_chatgpt_active" id="prompt_chatgpt_active"
                                                            class="no-dk styled-select color-blue">
                                                            <option value="0" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getPromptChatgptActive() == "0") ? 'selected' : ''?>>
                                                                <?php echo p__("Migachat", 'Disable')?>
                                                            </option>
                                                            <option value="1" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getPromptChatgptActive() == "1") ? 'selected' : ''?>>
                                                                <?php echo p__("Migachat", 'Enable')?>
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="" <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getApiType() == "chatgpt") ? 'style="display:none;"' : '';?>>
                                                <div class="form-group">
                                                    <div class="col-md-4">
                                                        <label for="select-input">
                                                            <?php echo p__("Migachat", 'History For Webhooks')?>:
                                                        </label>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <select name="webhook_history" id="webhook_history"
                                                            class="no-dk styled-select color-blue">
                                                            <option value="0" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getWebhookHistory() == "0") ? 'selected' : '';?>>
                                                                <?php echo p__("Migachat", 'Disable');?>
                                                            </option>
                                                            <option value="1" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getWebhookHistory() == "1") ? 'selected' : '';?>>
                                                                <?php echo p__("Migachat", 'Enable');?>
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-md-4">
                                                        <label for="select-input">
                                                            <?php echo p__("Migachat", 'System prompt For Webhooks')?>:
                                                        </label>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <select name="prompt_webhook_active" id="prompt_webhook_active"
                                                            class="no-dk styled-select color-blue">
                                                            <option value="0" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getPromptWebhookActive() == "0") ? 'selected' : '';?>>
                                                                <?php echo p__("Migachat", 'Disable');?>
                                                            </option>
                                                            <option value="1" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getPromptWebhookActive() == "1") ? 'selected' : '';?>>
                                                                <?php echo p__("Migachat", 'Enable');?>
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label for="select-input">
                                                        <?php echo p__("Migachat", 'System prompt')?>:
                                                    </label>
                                                </div>
                                                <div class="col-md-8">
                                                    <textarea class="input-flat" name="system_prompt" id="system_prompt"
                                                        rows="20"><?php echo ($app_setting_obj->getSystemPrompt()) ? $app_setting_obj->getSystemPrompt() : 'I am a virtual assistant, my name is Valentina.'?></textarea>
                                                    <div> <span><strong>                                                                         <?php echo p__("Migachat", 'Last saved tokens'); ?>:
                                                            </strong> <?php echo $app_setting_obj->getSystemPromptTokens()?> /
                                                            <?php echo ($system_prompt_precentage / 100) * $total_tokens?></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="save pull-right">
                                                <button class="button btn btn-warning color-yellow" id="optimize_system_prompt">
                                                    <?php echo p__("Migachat", 'Optimze system prompt'); ?>
                                                </button>
                                                <button class="button btn btn-warning color-yellow"
                                                    id="translate_system_prompt">
                                                    <?php echo p__("Migachat", 'Translate the system prompt into English '); ?>
                                                </button>
                                                <button class="button btn bt_save btn color-blue" type="submit">
                                                    <?php echo p__("Migachat", 'Save'); ?>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <!-- openAi config end -->
                        <!-- assistant setting start -->
                         <div <?php echo ($chatbot_setting_obj->getId() && $chatbot_setting_obj->getUseAssistant() == "1") ? '' : 'style="display:none;"';?>>
                            <!-- OpenAi Config Start -->
                           <div class="content">
                                <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                    <?php echo p__("Migachat", 'Assistant Settings'); ?>
                                </h3>
                                <div class="container-fluid subcontent content-feature">
                                    <form id="assistantsettings" method="POST" enctype="multipart/form-data"
                                        action="<?php echo $this->getUrl('migachat/bridgeapi/saveassistantsettings') ?>">

                                        <input type="hidden" name="value_id" id="value_id" value="<?php echo $value_id; ?>" />
                                        <input type="hidden" name="app_id" id="app_id" value="<?php echo $app_id; ?>" />

                                        <!-- Assistant Selection -->
                                        <div class="form-horizontal">
                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label><?php echo p__("Migachat", 'Select ChatGPT Assistant')?>:</label>
                                                </div>
                                                <div class="col-md-6">
                                                    <select name="assistant_id" id="assistant_id_dd" class="no-dk styled-select color-blue">
                                                        <option value="0"><?php echo p__("Migachat", 'Select ChatGPT Assistant');?></option>
                                                        <option value="0"><?php echo p__("Migachat", 'Create New Assistant');?></option>
                                                        <?php foreach ($assistants as $assistant) {
                                                                        ?>
                                                                <option value="<?php echo $assistant['assistant_id'] ?>" <?php echo ($app_setting_obj->getAssistantId() && $app_setting_obj->getAssistantId() == $assistant['assistant_id'] ) ? 'selected' : '';?>>
                                                                    <?php echo $assistant['name'];?>
                                                                </option>
                                                        <?php }?>
                                                    </select>
                                                </div>
                                                <!-- <div class="col-md-2">
                                                    <button type="button" class="btn color-blue" data-toggle="modal" data-target="#createAssistantModal">
                                                        + <?php echo p__("Migachat", 'Create New')?>
                                                    </button>
                                                </div> -->
                                            </div>

                                            <!-- Assistant Name -->
                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label><?php echo p__("Migachat", 'Assistant Name')?>:</label>
                                                </div>
                                                <div class="col-md-8">
                                                    <input type="text" name="assistant_name" id="assistant_name" class="input-flat" placeholder="Friendly Assistant Name" />
                                                </div>
                                            </div>

                                            <!-- Assistant Description -->
                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label><?php echo p__("Migachat", 'Description')?>:</label>
                                                </div>
                                                <div class="col-md-8">
                                                    <textarea name="description" class="input-flat" id="assistant_description" placeholder="Brief assistant purpose"></textarea>
                                                </div>
                                            </div>

                                            <!-- Instructions -->
                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label><?php echo p__("Migachat", 'Instructions')?>:</label>
                                                </div>
                                                <div class="col-md-8">
                                                    <textarea name="instructions" id="assistant_instructions" class="input-flat" rows="5"
                                                            placeholder="e.g., You are a helpful assistant that responds politely..."></textarea>
                                                </div>
                                            </div>

                                            <!-- Model -->
                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label><?php echo p__("Migachat", 'Model')?>:</label>
                                                </div>
                                                <div class="col-md-8">
                                                    <select name="model" id="assistant_model"  class="no-dk styled-select color-blue">
                                                        <?php foreach ($gpt_models_with_limit as $key => $value) {
                                                                        ?>
                                                                <option value="<?php echo $key?>" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getGptModel() == $key) ? 'selected' : '';?>>
                                                                    <?php echo $value;?>
                                                                </option>
                                                            <?php }?>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- File Attachments -->
                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label><?php echo p__("Migachat", 'Attach Files')?>:</label>
                                                </div>
                                                <div class="col-md-8">
                                                    <input type="file" name="attached_file" multiple class="input-flat" />
                                                    <p class="help-block"><?= p__("Migachat","Upload PDFs, docs, etc. (Max 20MB each)") ?></p>
                                                    <!-- List existing files -->
                                                    <div id="existing_files">
                                                        <!-- PHP loop to list current attached files -->
                                                        <!-- <li>file1.pdf <a href="#" class="remove-file">Remove</a></li> -->
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- top p and temprature -->
                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label><?php echo p__("Migachat", 'Top P')?>:</label>
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="number" min="0" max="1" step="0.01" name="top_p"
                                                        value="" id="top_p-input"
                                                        class="required input-flat">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="col-md-4">
                                                    <label><?php echo p__("Migachat", 'Temperature')?>:</label>
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="number" min="0" max="1" step="0.01" name="temperature"
                                                        value="" id="temperature-input"
                                                        class="required input-flat">
                                                </div>
                                            </div>


                                        </div>

                                        <div class="save pull-right">
                                            <button class="button btn bt_save btn color-blue" type="submit">
                                                <?php echo p__("Migachat", 'Save'); ?>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <!-- new assistant popup -->
                             <div class="modal fade" id="createAssistantModal" tabindex="-1" role="dialog" aria-labelledby="createAssistantModalLabel">
                                <div class="modal-dialog" role="document">
                                    <form id="create_assistant_form" method="POST" action="<!-- route to handle creation -->">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                        <h4 class="modal-title" id="createAssistantModalLabel"><?= p__("Migachat", 'Create New Assistant') ?></h4>
                                        </div>
                                        <div class="modal-body">

                                        <div class="form-group">
                                            <label><?= p__("Migachat", 'Name') ?></label>
                                            <input type="text" name="new_name" class="input-flat" required>
                                        </div>

                                        <div class="form-group">
                                            <label><?= p__("Migachat", 'Instructions') ?></label>
                                            <textarea name="new_instructions" class="input-flat" required></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label><?= p__("Migachat", 'Model') ?></label>
                                            <select name="new_model"  class="no-dk styled-select color-blue">
                                            <?php foreach ($gpt_models_with_limit as $key => $value) {
                                                                        ?>
                                                    <option value="<?php echo $key?>" <?php echo ($app_setting_obj->getId() && $app_setting_obj->getGptModel() == $key) ? 'selected' : '';?>>
                                                        <?php echo $value;?>
                                                    </option>
                                                <?php }?>
                                            </select>
                                        </div>

                                        </div>
                                        <div class="modal-footer">
                                        <button type="submit" class="btn color-blue"><?= p__("Migachat", 'Create') ?></button>
                                        <button type="button" class="btn color-orange" data-dismiss="modal"><?= p__("Migachat", 'Cancel') ?></button>
                                        </div>
                                    </div>
                                    </form>
                                </div>
                                </div>

                        </div>
                        <!--  temp / permanent blacklist  Config Start -->
                        <div class="content">
                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'Temporary / Permanent Blacklist Configuration'); ?>
                            </h3>
                            <div class="container-fluid subcontent content-feature">
                                <form id="blacklist_config" method="POST" action="<?php echo $this->getUrl('migachat/application/saveblacklistconfig') ?>">
                                    <input type="hidden" name="value_id" id="value_id" value="<?php echo $value_id; ?>" />
                                    <div class="form-horizontal">
                                        <div class="form-group ">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'Temporary blacklist duration (in hours)')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="number" min="1" name="temporary_blacklist_duration" id="temporary_blacklist_duration"
                                                    value="<?php echo ($app_setting_obj->getId() && $app_setting_obj->getTemporaryBlacklistDuration()) ? $app_setting_obj->getTemporaryBlacklistDuration() : '0';?>"
                                                    class="required input-flat">
                                            </div>
                                            <div class="col-md-4"> <p class="text-muted"> <strong> <?php echo p__("Migachat", 'Note')?>:</strong><?php echo p__("Migachat", 'This setting dynamically applies the "Temporary Blacklist Duration" (in hours) when manually blocking a Bridge API user through the UI.')?> </p> </div>
                                        </div>
                                        <div class="form-group ">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'Permanent blacklisted mobile numbers')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-8">
                                                <textarea class="input-flat" name="permanent_blacklisted_mobile_numbers" id="permanent_blacklisted_mobile_numbers" rows="5">
                                                    <?php echo ($app_setting_obj->getId() && $app_setting_obj->getPermanentBlacklistedMobileNumbers()) ? $app_setting_obj->getPermanentBlacklistedMobileNumbers() : '';?>
                                                </textarea>
                                                <p class="text-muted"><?php echo p__("Migachat", 'Add comma-separated mobile numbers to be permanently blacklisted from Bridge API.')?> </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="save pull-right">
                                        <button class="button btn bt_save btn color-blue" type="submit">
                                            <?php echo p__("Migachat", 'Save'); ?>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- temp / permanent blacklist config end -->
                        <div class="content">
                            <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                                <?php echo p__("Migachat", 'Bridge API configrations');

                                        ?>
                                <a href="https://docs.google.com/document/d/1RDv5HftdkwUYIY4hnhWor4AD9fKb1By5bGl4IGlAnDY"
                                    target="_blank" class="link-help  pull-right"> <small
                                        class=""><?php echo p__("Migachat", 'Documentation');?> : </small><i
                                        class="fa fa-file-text-o"></i></a>

                            </h3>
                            <div class="container-fluid subcontent content-feature">

                                <form id="bridge_api_form" method="POST"
                                    action="<?php echo $this->getUrl('migachat/application/savebridgeapisettings') ?>">

                                    <input type="hidden" name="value_id" id="value_id" value="<?php echo $value_id; ?>" />
                                    <div class="form-horizontal">
                                        <div class="form-group">
                                            <div class="col-md-2">
                                                <label for="webhook-url-input">
                                                    <?php echo p__("Migachat", 'Authentication Token');?>:
                                                </label>
                                            </div>

                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-primary btn-sm"
                                                    id="generate-auth-token_bridge">
                                                    <i class="fa fa-refresh"></i>
                                                </button>
                                            </div>
                                            <div class="col-md-8">
                                                <input type="text" name="auth_token" id="auth-token_bridge"
                                                    value="<?php echo ($bridge_obj->getId()) ? $bridge_obj->getAuthToken() : $randomBridgeString;?>"
                                                    class="required input-flat">
                                            </div>
                                        </div>

                                        <div class="form-group ">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'Overall duration for tokens limit')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="number" min="0" name="overall_duration" id="overall_duration"
                                                    value="<?php echo ($bridge_obj->getId()) ? $bridge_obj->getOverallDuration() : 24;?>"
                                                    class="required input-flat">
                                            </div>
                                            <div class="col-md-1"><?php echo p__("Migachat", 'HOURS')?></div>
                                        </div>

                                        <div class="form-group">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'Overall tokens limit')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="number" min="0" name="overall_limit" id="overall_limit"
                                                    value="<?php echo ($bridge_obj->getId()) ? $bridge_obj->getOverallLimit() : 2500000;?>"
                                                    class="required input-flat">
                                            </div>
                                            <div class="col-md-1"><?php echo p__("Migachat", 'TOKENS')?></div>
                                        </div>

                                        <div class="form-group">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'Per chat id tokens limit duration')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-4">
                                                <select name="user_duration" id="user_duration"
                                                    class="no-dk styled-select color-blue">
                                                    <option value="60" <?php echo ($bridge_obj->getId() && $bridge_obj->getUserDuration() == "60") ? 'selected' : '';?>>
                                                        60 <?php echo p__("Migachat", 'Minutes');?></option>
                                                    <option value="15" <?php echo ($bridge_obj->getId() && $bridge_obj->getUserDuration() == "15") ? 'selected' : '';?>>
                                                        15 <?php echo p__("Migachat", 'Minutes');?></option>
                                                    <option value="30" <?php echo ($bridge_obj->getId() && $bridge_obj->getUserDuration() == "30") ? 'selected' : '';?>>
                                                        30 <?php echo p__("Migachat", 'Minutes');?></option>
                                                    <option value="45" <?php echo ($bridge_obj->getId() && $bridge_obj->getUserDuration() == "45") ? 'selected' : '';?>>
                                                        45 <?php echo p__("Migachat", 'Minutes');?></option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'Per chat id tokens limit')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="number" min="0" name="user_limit" id="user_limit"
                                                    value="<?php echo ($bridge_obj->getId()) ? $bridge_obj->getUserLimit() : 100000;?>"
                                                    class="required input-flat">
                                            </div>
                                            <div class="col-md-1"><?php echo p__("Migachat", 'TOKENS')?></div>
                                        </div>

                                        <div class="form-group">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'User chat limit exceed responce')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-8">
                                                <textarea class="input-flat" name="user_chat_limit_responce"
                                                    id="user_chat_limit_responce"
                                                    rows="10"><?php echo $bridge_obj->getUserChatLimitResponce()?></textarea>

                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'AI answer token limit')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="number" min="0" name="ai_answer_token_limit"
                                                    id="ai_answer_token_limit"
                                                    value="<?php echo ($bridge_obj->getId()) ? $bridge_obj->getAiAnswerTokenLimit() : 500;?>"
                                                    class="required input-flat">
                                            </div>
                                            <div class="col-md-1"><?php echo p__("Migachat", 'TOKENS')?></div>
                                        </div>
                                        <div class="form-group">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'AI and Token limit (suspension duration)')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="number" min="0" max="24" name="suspention_duration"
                                                    id="suspention_duration"
                                                    value="<?php echo ($bridge_obj->getId()) ? $bridge_obj->getSuspentionDuration() : 1?>"
                                                    class="required input-flat">
                                            </div>
                                            <div class="col-md-1"><?php echo p__("Migachat", 'HOURS')?></div>
                                            <div class="col-md-3"><b><u><?php echo p__("Migachat", '0 forever')?></u></b></div>
                                        </div>
                                        <div class="form-group">
                                            <div class="col-md-4">
                                                <label for="select-input">
                                                    <?php echo p__("Migachat", 'AI answer continue confirmation message after cut off responce')?>:
                                                </label>
                                            </div>
                                            <div class="col-md-8">
                                                <textarea class="input-flat" name="ai_answer_token_limit_msg"
                                                    id="ai_answer_token_limit_msg"
                                                    rows="10"><?php echo $bridge_obj->getAiAnswerTokenLimitMsg()?></textarea>

                                            </div>
                                        </div>
                                        <div class="save pull-right">
                                            <button class="button btn bt_save btn color-blue" type="submit">
                                                <?php echo p__("Migachat", 'Save'); ?>
                                            </button>
                                        </div>

                                </form>
                            </div>
                            <br>
                            <br>
                            <hr>
                            <br>

                            <?php
                            if ($bridge_obj->getDisableApi()) {?>
                                <button type="button" class="button btn btn color-green btn-block btn-success"
                                    id="disable-bridge-api"><?php echo p__("Migachat", 'Enable Bridge API?')?></button>
                                <?php
                                } else {?>
                                <button type="button" class="button btn btn color-red btn-block btn-danger"
                                    id="disable-bridge-api"><?php echo p__("Migachat", 'Disable Bridge API?')?></button>
                            <?php }
                                    ?>
                            <div class="alert alert-info">
                                <?php echo p__("Migachat", 'Instance ID');?> =
                                <b>
                                    <?php echo $value_id?>
                                </b>
                            </div>
                            <div class="alert alert-info">
                                <?php echo p__("Migachat", 'The Bridge API URL');?>:
                                <b>
                                    <?php echo $main_domain?>/migachat/public_bridgeapi/sendmessage
                                </b>
                            </div>
                            <div class="alert alert-info">
                                <?php echo p__("Migachat", 'The API request must containt these parameters');?>:
                                <b>('message','instance_id','auth_token')</b>
                            </div>
                            <div class="alert alert-info">
                                <?php echo p__("Migachat", 'The API optional parameters');?>:
                                <b>('channel','role','chat_id','mobile','email','name')</b>
                            </div>

                            <div class="alert alert-warning">
                                <?php echo p__("Migachat", 'To turn off the AI responce for a chat id send');?> <b>`##off##`</b>.
                            </div>
                            <div class="alert alert-warning">
                                <?php echo p__("Migachat", 'To turn back on the AI responce for a chat id send');?>
                                <b>`##on##`</b>.
                            </div>
                            <div class="alert alert-warning">
                                <?php echo p__("Migachat", 'To turn off the tokens limit for a chat id send');?>
                                <b>`##limitoff##`</b>.
                            </div>
                            <div class="alert alert-danger">
                                <?php echo p__("Migachat", 'Warning! you can not turn back on the tokens limit once it turned off.');?>
                            </div>
                        </div>
                    </div>
                    <div class="content">
                        <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                            <?php echo p__("Migachat", 'OpenAI custom model tokens limit'); ?>
                        </h3>
                        <div class="container-fluid subcontent content-feature">

                            <form id="models_token_form" method="POST"
                                action="<?php echo $this->getUrl('migachat/application/savecustommodeltokens') ?>">

                                <input type="hidden" name="value_id" id="value_id" value="<?php echo $value_id; ?>" />
                                <table class="table table-bordered content-white-bkg">
                                    <thead>
                                        <tr>
                                            <th>                                                 <?php echo p__("Migachat", 'Model Name'); ?></th>
                                            <th>                                                 <?php echo p__("Migachat", 'Tokens Limit'); ?></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php foreach ($model_limit as $key => $value) {?>
                                            <tr>
                                                <th>                                                     <?php echo $key; ?></th>
                                                <td> <input type="number" min="0" class="input-flat" id="<?php echo $key;?>"
                                                        value="<?php echo $value; ?>" name="tokens_limit[<?php echo $key;?>]"></td>
                                            </tr>
                                        <?php }?>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="2">

                                                <div class="save pull-right">
                                                    <button class="button btn bt_save btn color-blue" type="submit">
                                                        <?php echo p__("Migachat", 'Save'); ?>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </form>
                        </div>

                        <?php echo $this->importLayout($option_value, false); ?>

                        <?php echo $this->importBackground($option_value, false); ?>
                    </div>

                </div>
                <!-- /END DESIGN TAB -->
                <!-- START gdpr_settings TAB -->
                <?php
                    // count 142
                            $languages_list = [
                                "sq"  => "Albanian",
                                "am"  => "Amharic",
                                "ar"  => "Arabic",
                                "an"  => "Aragonese",
                                "hy"  => "Armenian",
                                "ast" => "Asturian",
                                "az"  => "Azerbaijani",
                                "eu"  => "Basque",
                                "be"  => "Belarusian",
                                "bg"  => "Bulgarian",
                                "ca"  => "Catalan",
                                "ckb" => "Central Kurdish",
                                "zh"  => "Chinese",
                                "co"  => "Corsican",
                                "hr"  => "Croatian",
                                "cs"  => "Czech",
                                "da"  => "Danish",
                                "nl"  => "Dutch",
                                "en"  => "English",
                                "eo"  => "Esperanto",
                                "et"  => "Estonian",
                                "fo"  => "Faroese",
                                "fil" => "Filipino",
                                "fi"  => "Finnish",
                                "fr"  => "French",
                                "gl"  => "Galician",
                                "ka"  => "Georgian",
                                "de"  => "German",
                                "el"  => "Greek",
                                "haw" => "Hawaiian",
                                "he"  => "Hebrew",
                                "hu"  => "Hungarian",
                                "is"  => "Icelandic",
                                "id"  => "Indonesian",
                                "ia"  => "Interlingua",
                                "ga"  => "Irish",
                                "it"  => "Italian",
                                "ja"  => "Japanese",
                                "kn"  => "Kannada",
                                "kk"  => "Kazakh",
                                "km"  => "Khmer",
                                "ko"  => "Korean",
                                "ku"  => "Kurdish",
                                "ky"  => "Kyrgyz",
                                "la"  => "Latin",
                                "lv"  => "Latvian",
                                "ln"  => "Lingala",
                                "lt"  => "Lithuanian",
                                "mk"  => "Macedonian",
                                "mt"  => "Maltese",
                                "no"  => "Norwegian",
                                "oc"  => "Occitan",
                                "pl"  => "Polish",
                                "pt"  => "Portuguese",
                                "qu"  => "Quechua",
                                "ro"  => "Romanian",
                                "ru"  => "Russian",
                                "gd"  => "Scottish Gaelic",
                                "sr"  => "Serbian",
                                "sh"  => "Serbo",
                                "sk"  => "Slovak",
                                "sl"  => "Slovenian",
                                "so"  => "Somali",
                                "es"  => "Spanish",
                                "sv"  => "Swedish",
                                "tr"  => "Turkish",
                                "uk"  => "Ukrainian",
                            ];
                        ?>
                <div role="tabpanel" class="tab-pane" id="gdpr_settings">
                    <div class="content">
                        <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                            <?php echo p__("Migachat", 'GDPR Settings'); ?>
                        </h3>
                        <div class="container-fluid content-feature pt30">
                            <form id="gdpr_settings_form" method="POST"
                                action="<?php echo $this->getUrl('migachat/application/savegdprsettings') ?>">

                                <input type="hidden" name="value_id" id="value_id" value="<?php echo $value_id; ?>" />

                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Select Default Language')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <select name="default_language" id="default_language"
                                                class="no-dk styled-select color-blue">

                                                <?php foreach ($languages_list as $key => $language) {?>
                                                    <option value="<?php echo $key?>" <?php echo ($gdpr_settings->getDefaultLanguage() == $key ? 'selected' : '')?>>
                                                        <?php echo $language;?>
                                                    </option>
                                                <?php }?>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'GDPR privacy Enabled?')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <select name="gdpr_active" id="gdpr_active"
                                                class="no-dk styled-select color-blue">
                                                <option value="0" <?php echo ($gdpr_settings->getGdprActive() == '0' ? 'selected' : '')?>>
                                                    <?php echo p__("Migachat", 'No');?>
                                                </option>
                                                <option value="1" <?php echo ($gdpr_settings->getGdprActive() == '1' ? 'selected' : '')?>>
                                                    <?php echo p__("Migachat", 'Yes');?>
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group ">
                                        <div class="col-md-4">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'GDPR privacy link')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" min="0" name="gdpr_link" id="gdpr_link"
                                                placeholder="https://www.yourdomain.com/privacy"
                                                value="<?php echo ($gdpr_settings->getGdprLink()) ? $gdpr_settings->getGdprLink() : ''?>"
                                                class="required input-flat">
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <?php echo p__("Migachat", 'Only add the messages in one language, System will adjust the translation according the user language.');?>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            <label for="gdpr_welcome_text">
                                                <?php echo p__("Migachat", 'GDPR welcome text');?>:
                                            </label>
                                        </div>
                                        <div class="col-md-8">
                                            <textarea class="input-flat" name="gdpr_welcome_text" id="gdpr_welcome_text"
                                                rows="10"><?php echo ($gdpr_settings->getGdprWelcomeText()) ? $gdpr_settings->getGdprWelcomeText() : 'Dear user, in order to write to us I need you to confirm that you have read our privacy policy which can be found at this link here below. Please therefore simply reply with a YES to this message.'?></textarea>

                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            <label for="gdpr_success_text">
                                                <?php echo p__("Migachat", 'GDPR accept text');?>:
                                            </label>
                                        </div>
                                        <div class="col-md-8">
                                            <textarea class="input-flat" name="gdpr_success_text" id="gdpr_success_text"
                                                rows="10"><?php echo ($gdpr_settings->getGdprSuccessText()) ? $gdpr_settings->getGdprSuccessText() : 'Compliments! Now we can start chatting together.'?></textarea>

                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            <label for="gdpr_failure_text">
                                                <?php echo p__("Migachat", 'GDPR denied text');?>:
                                            </label>
                                        </div>
                                        <div class="col-md-8">
                                            <textarea class="input-flat" name="gdpr_failure_text" id="gdpr_failure_text"
                                                rows="10"><?php echo ($gdpr_settings->getGdprFailureText()) ? $gdpr_settings->getGdprFailureText() : 'I am sorry but to proceed you must write YES.'?></textarea>

                                        </div>
                                    </div>

                                    <div class="form-group ">
                                        <div class="col-md-4">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'Reset duration')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" min="0" name="gdpr_reset" id="gdpr_reset"
                                                value="<?php echo ($gdpr_settings->getGdprReset()) ? $gdpr_settings->getGdprReset() : 60?>"
                                                class="required input-flat">
                                        </div>
                                        <div class="col-md-1">
                                            <?php echo p__("Migachat", 'Minutes')?>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            <label for="select-input">
                                                <?php echo p__("Migachat", 'COMMERCIAL CONSENT Enabled?')?>:
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <select name="commercial_active" id="commercial_active"
                                                class="no-dk styled-select color-blue">
                                                <option value="0" <?php echo ($gdpr_settings->getCommercialActive() == '0') ? 'selected' : ''?>>
                                                    <?php echo p__("Migachat", 'No');?>
                                                </option>
                                                <option value="1" <?php echo ($gdpr_settings->getCommercialActive() == '1') ? 'selected' : ''?>>
                                                    <?php echo p__("Migachat", 'Yes');?>
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            <label for="webhook-url-input">
                                                <?php echo p__("Migachat", 'COMMERCIAL CONSENT welcome text');?>:
                                            </label>
                                        </div>
                                        <div class="col-md-8">
                                            <textarea class="input-flat" name="commercial_welcome_text"
                                                id="commercial_welcome_text"
                                                rows="10"><?php echo ($gdpr_settings->getCommercialWelcomeText()) ? $gdpr_settings->getCommercialWelcomeText() : 'Perfect! Now I need to collect your consent to share commercial information with you on this chat or other communication channels. Answer YES if you give consent or NO if you dont.'?></textarea>

                                        </div>
                                    </div>



                                    <div class="save pull-right">
                                        <button class="button btn bt_save btn color-blue" type="submit">
                                            <?php echo p__("Migachat", 'Save'); ?>
                                        </button>
                                    </div>

                            </form>
                        </div>
                    </div>
                </div>
                <div class="content">

                    <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                        <button class="button btn btn color-red"
                            id="reset_privacy_consent_for_all"><?php echo p__("Migachat", 'Collect the privacy consent again for all chat ids');?></button>
                    </h3>
                </div>
                <div class="content">

                    <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                        <?php echo p__("Migachat", 'Bridge API GDPR'); ?>

                        <button class="button btn btn color-blue pull-right"
                            id="csv_privacy_consent_for_all"><?php echo p__("Migachat", 'Export CSV');?></button>
                    </h3>
                    <div class="container-fluid content-feature pt30" style="height:500px;overflow:auto;">
                        <table id="received_table" style="width:100%;" class="table content-white-bkg margin-top">
                            <thead>
                                <tr>
                                    <th>
                                        <?php echo p__("Migachat", "Chat Id")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Name")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Email")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Mobile")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "GDPR privacy")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Commercial consent")?>
                                    </th>
                                    <!-- <th>
                                                    <?php echo p__("Migachat", "Action")?>
                                                </th> -->
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($chat_ids as $key => $value) {
                                                if ($value['gdpr_consent'] == 1) {
                                                ?>
                                        <tr>
                                            <td> <?php echo $value['chat_id']?> </td>
                                            <td> <?php echo $value['user_name']?> </td>
                                            <td> <?php echo $value['user_email']?> </td>
                                            <td> <?php echo $value['user_mobile']?> </td>
                                            <td>
                                                <?php echo ($value['gdpr_consent'] == 1) ? $value['gdpr_consent_timestamp'] : p__("Migachat", "No GDPR consent")?>
                                                <br>
                                                <?php echo ($value['gdpr_consent_external'] == 1) ? p__("Migachat", "External") : ''?>
                                            </td>
                                            <td>
                                                <?php echo ($value['commercial_consent'] == 1) ? $value['commercial_consent_timestamp'] : p__("Migachat", "No commercial consent")?>
                                                <br>
                                                <?php echo ($value['commercial_consent_external'] == 1) ? p__("Migachat", "External") : ''?>
                                            </td>
                                            <!-- <td>
                                                        <button class="button btn btn-warning color-yellow" onclick="resetConsent(<?php echo $value['chat_id']?>)">
                                                            <?php echo p__("Migachat", 'Reset the privacy consent'); ?>
                                                        </button>
                                                    </td> -->
                                        </tr>
                                        <?php
                                            }
                                                }?>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <!-- /END gdpr_settings TAB -->
            <!-- Operator settings start -->
            <div role="tabpanel" class="tab-pane" id="operator_settings">
                <div class="content">
                    <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                        <?php echo p__("Migachat", 'Operator Settings'); ?>
                    </h3>
                    <div class="container-fluid content-feature pt30">
                        <form id="operator_settings_form" method="POST"
                            action="<?php echo $this->getUrl('migachat/application/saveoperatorsettings') ?>">

                            <input type="hidden" name="value_id" id="value_id" value="<?php echo $value_id; ?>" />

                            <div class="form-horizontal">
                                <!-- operator In app enabled -->
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="select-input">
                                            <?php echo p__("Migachat", 'Enabled for In-App chat?')?>:
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <select name="is_enabled_in_app" id="is_enabled_in_app"
                                            class="no-dk styled-select color-blue">
                                            <option value="0" <?php echo ($is_enabled_in_app === '0' ? 'selected' : '')?>>
                                                <?php echo p__("Migachat", 'No');?>
                                            </option>
                                            <option value="1" <?php echo ($is_enabled_in_app === '1' ? 'selected' : '')?>>
                                                <?php echo p__("Migachat", 'Yes');?>
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <!-- operator bridge ApI enabled -->
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="select-input">
                                            <?php echo p__("Migachat", 'Enabled for Bridge API chat?')?>:
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <select name="is_enabled_bridge_api" id="is_enabled_bridge_api"
                                            class="no-dk styled-select color-blue">
                                            <option value="0" <?php echo ($is_enabled_bridge_api === '0' ? 'selected' : '')?>>
                                                <?php echo p__("Migachat", 'No');?>
                                            </option>
                                            <option value="1" <?php echo ($is_enabled_bridge_api === '1' ? 'selected' : '')?>>
                                                <?php echo p__("Migachat", 'Yes');?>
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="operator_default_language">
                                            <?php echo p__("Migachat", 'Select Default Language');?>:
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <select name="default_language" id="operator_default_language"
                                            class="no-dk styled-select color-blue">
                                            <?php if (! empty($languages_list)) {
                                                foreach ($languages_list as $lang_key => $language) {?>
                                                    <option value="<?php echo $lang_key; ?>" <?php echo ($operator_language_value === $lang_key ? 'selected' : ''); ?>>
                                                        <?php echo $language; ?>
                                                    </option>
                                            <?php }
                                            }?>
                                        </select>
                                    </div>
                                </div>
                                <!-- operator Webhook URL-->
                                <div class="form-group ">
                                    <div class="col-md-4">
                                        <label for="select-input">
                                            <?php echo p__("Migachat", 'Webhook URL')?>:
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" min="0" name="webhook_url" id="webhook_url_operator"
                                            placeholder="https://www.yourdomain.com/etc"
                                            value="<?php echo ($operator_settings->getWebhookUrl()) ? $operator_settings->getWebhookUrl() : ''?>"
                                            class="required input-flat">
                                    </div>
                                    <div class="col-md-4">
                                        <p class="text-muted">
                                            <button id="test_webhook" class="btn button color-blue"><?php echo p__("Migachat", 'Test Webhook')?></button>
                                        </p>
                                        <p class="text-muted">
                                            <?php echo p__("Migachat", 'The webhook must receive post request.')?>
                                        </p>
                                        <p class="text-muted">
                                            <?php echo p__("Migachat", 'The post request will have following params:')?>
                                            <ul>
                                                <li>chat_type (in_app,api)</li>
                                                <li>user_id</li>
                                                <li>app_id</li>
                                                <li>app_name</li>
                                                <li>instance_id</li>
                                                <li>operator_request_id</li>
                                                <li>user_email</li>
                                                <li>user_mobile</li>
                                                <li>date_time</li>
                                                <li>last_five_history</li>
                                            </ul>
                                        </p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="operator_system_prompt">
                                            <?php echo p__("Migachat", 'System Prompt to check if user asked for operator to contact');?>:
                                        </label>
                                    </div>
                                    <div class="col-md-8">
                                        <textarea class="input-flat" name="operator_system_prompt"
                                            id="operator_system_prompt"
                                            rows="10"><?php echo $operator_system_prompt_value; ?></textarea>


                                        <p class="text-muted">
                                            @@last_five_history@@
                                        </p>
                                    </div>
                                </div>


                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="ask_call_from_operator_msg">
                                            <?php echo p__("Migachat", 'Ask for call from operator text');?>:
                                        </label>
                                    </div>
                                    <div class="col-md-8">
                                        <textarea class="input-flat" name="ask_call_from_operator_msg"
                                            id="ask_call_from_operator_msg"
                                            rows="10"><?php echo $ask_call_from_operator_value; ?></textarea>

                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="confirm_call_from_operator_msg">
                                            <?php echo p__("Migachat", 'Confirm call from operator responce text');?>:
                                        </label>
                                    </div>
                                    <div class="col-md-8">
                                        <textarea class="input-flat" name="confirm_call_from_operator_msg"
                                            id="confirm_call_from_operator_msg"
                                            rows="10"><?php echo $confirm_call_from_operator_val; ?></textarea>

                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="invalid_ask_call_from_operator_msg">
                                            <?php echo p__("Migachat", 'Invalid call from operator responce text');?>:
                                        </label>
                                    </div>
                                    <div class="col-md-8">
                                        <textarea class="input-flat" name="invalid_ask_call_from_operator_msg"
                                            id="invalid_ask_call_from_operator_msg"
                                            rows="10"><?php echo $invalid_call_from_operator_val; ?></textarea>

                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="declined_call_from_operator_msg">
                                            <?php echo p__("Migachat", 'Decline call from operator responce text');?>:
                                        </label>
                                    </div>
                                    <div class="col-md-8">
                                        <textarea class="input-flat" name="declined_call_from_operator_msg"
                                            id="declined_call_from_operator_msg"
                                            rows="10"><?php echo $declined_call_from_operator_val; ?></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="additional_emails">
                                            <?php echo p__("Migachat", 'Add comma-separated emails to send notification');?>:
                                        </label>
                                    </div>
                                    <div class="col-md-8">
                                        <textarea class="input-flat" name="additional_emails" id="additional_emails"
                                            rows="3"><?php echo ($operator_settings->getAdditionalEmails()) ? $operator_settings->getAdditionalEmails() : ''?></textarea>

                                        <p class="text-muted">
                                            <?php echo p__("Migachat", 'By-default the email will be sent to admins.');?>
                                        </p>
                                    </div>

                                </div>
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="email_subject">
                                            <?php echo p__("Migachat", 'Email Subject');?>:
                                        </label>
                                    </div>
                                    <div class="col-md-8">
                                        <textarea class="input-flat" name="email_subject" id="email_subject"
                                            rows="10"><?php echo $email_subject_value; ?></textarea>

                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label for="email_template">
                                            <?php echo p__("Migachat", 'Email Template');?>:
                                        </label>
                                    </div>
                                    <div class="col-md-8">
                                        <textarea class="input-flat" name="email_template" id="email_template"
                                            rows="10"><?php echo $email_template_value; ?></textarea>
                                        <p class="text-muted">
                                            <?php echo p__("Migachat", 'The email template can contain the following placeholders:');?>
                                        <ul>
                                            <li>@@app_id@@ , @@app_name@@ , @@instance_id@@ , @@user_name@@ , @@user_email@@
                                                , @@user_mobile@@ , @@chat_id@@ , @@chat_type@@ , @@operator_request_id@@ ,
                                                @@date_time@@, '@@last_five_history@@'</li>
                                        </ul>
                                        </p>
                                    </div>

                                </div>




                                <div class="save pull-right">
                                    <button class="button btn bt_save btn color-blue" type="submit">
                                        <?php echo p__("Migachat", 'Save'); ?>
                                    </button>
                                </div>
                            </div>

                        </form>
                    </div>
                </div>
                <div class="content">

                    <h3 class="title-editor no-border-radius title-feature-indent border-blue">
                        <?php echo p__("Migachat", 'Call from operator requests'); ?>

                    </h3>
                    <div class="container-fluid content-feature pt30" style="height:500px;overflow:auto;">
                        <table id="request_table" style="width:100%;" class="table content-white-bkg margin-top">
                            <thead>
                                <tr>
                                    <th>
                                        <?php echo p__("Migachat", "User Id")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Name")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Email")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Mobile")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Date Time")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Bot Type")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Status")?>
                                    </th>
                                    <th>
                                        <?php echo p__("Migachat", "Action")?>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($operator_requests as $key => $value) {
                                            ?>
                                    <tr>
                                        <td> <?php echo $value['user_id']?> </td>
                                        <td> <?php echo $value['user_name']?> </td>
                                        <td> <?php echo $value['user_email']?> </td>
                                        <td> <?php echo $value['user_mobile']?> </td>
                                        <td> <?php echo $value['created_at']?> </td>
                                        <td> <?php echo strtoupper(str_replace('_', ' ', $value['bot_type']))?> </td>
                                        <td> <?php echo p__('Migachat', $value['status'])?> </td>
                                        <td>
                                            <?php if ($value['status'] == 'pending') {?>
                                                <button class="btn btn-warning btn-xs accepted_request"
                                                    data-migachat_operator_request_id="<?php echo $value['migachat_operator_request_id']?>"><?php echo p__('Migachat', 'Accepted')?></button>
                                            <?php }?>
                                        </td>

                                    </tr>
                                    <?php
                                        }
                                            ?>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <!-- /END operator settings  -->
        </div>
    </div>
    </div>
    </div>

    <div id="app_delete_single_chat_history" class="app_delete_single_chat_history">
        <div class="app_delete_single_chat_history-content">
            <span class="button btn btn-red color-red pull-right" id="close-app_delete_single_chat_history"><b>X</b></span>
            <div class="app_delete_single_chat_history-header"><?php echo p__("Migachat", 'Confirm Deletion');?></div>
            <div class="app_delete_single_chat_history-textarea">
                <p><?php echo P__("Migachat", 'Are you sure you want to delete this user\'s chat history?')?></p>
            </div>
            <button class="button btn btn color-blue pull-right"
                onclick="deleteAppChat(2,1)"><?php echo p__("Migachat", 'No');?></button>
            <button class="button btn btn-danger color-red pull-left"
                onclick="deleteAppChat(2,2)"><?php echo p__("Migachat", 'Yes I want to to delete');?></button>
        </div>
    </div>
    <div id="app_delete_all_chat_history" class="app_delete_all_chat_history">
        <div class="app_delete_all_chat_history-content">
            <span class="button btn btn-red color-red pull-right" id="close-app_delete_all_chat_history"><b>X</b></span>
            <div class="app_delete_all_chat_history-header"><?php echo p__("Migachat", 'Confirm Deletion');?></div>
            <div class="app_delete_all_chat_history-textarea">
                <p><?php echo P__("Migachat", 'Are You sure you want to delete chat history of this instance?')?></p>
            </div>
            <button class="button btn btn color-blue pull-right"
                id="app_delete_all_chat_history_complete"><?php echo p__("Migachat", 'No');?></button>
            <button class="button btn btn-warning color-yellow pull-left" id="app_delete_all_chat_history_chat"
                onclick="deleteAppChat(1,2)"><?php echo p__("Migachat", 'Yes I want to to delete');?></button>
        </div>
    </div>
    <div id="api_delete_single_chat_history" class="api_delete_single_chat_history">
        <div class="api_delete_single_chat_history-content">
            <span class="button btn btn-red color-red pull-right" id="close-api_delete_single_chat_history"><b>X</b></span>
            <div class="api_delete_single_chat_history-header"><?php echo p__("Migachat", 'Confirm Deletion');?></div>
            <div class="api_delete_single_chat_history-textarea">
                <p><?php echo P__("Migachat", 'We can completely delete the chat and its data, or we can delete the history while maintaining the user data, the chat id and the first interaction on the chat. We recommend deleting the chat completely only in cases of explicit requests from the user, for example regarding privacy.')?>
                </p>
            </div>
            <button class="button btn btn color-blue pull-right" id="api_delete_single_chat_history_complete"
                onclick="deleteApiChat(2,1)"><?php echo p__("Migachat", 'Delete complete chat history and chat id data');?></button>
            <button class="button btn btn-warning color-yellow pull-left" id="api_delete_single_chat_history_chat"
                onclick="deleteApiChat(2,2)"><?php echo p__("Migachat", 'Delete only chat history keeping first interaction');?></button>
        </div>
    </div>
    <div id="api_delete_all_chat_history" class="api_delete_all_chat_history">
        <div class="api_delete_all_chat_history-content">
            <span class="button btn btn-red color-red pull-right" id="close-api_delete_all_chat_history"><b>X</b></span>
            <div class="api_delete_all_chat_history-header"><?php echo p__("Migachat", 'Confirm Deletion');?></div>
            <div class="api_delete_all_chat_history-textarea">
                <p><?php echo P__("Migachat", 'We can completely delete the chat and its data, or we can delete the history while maintaining the user data, the chat id and the first interaction on the chat. We recommend deleting the chat completely only in cases of explicit requests from the user, for example regarding privacy.')?>
                </p>
            </div>
            <button class="button btn btn color-blue pull-right" id="api_delete_all_chat_history_complete"
                onclick="deleteApiChat(1,1)"><?php echo p__("Migachat", 'Delete complete chat history and chat id data');?></button>
            <button class="button btn btn-warning color-yellow pull-left" id="api_delete_all_chat_history_chat"
                onclick="deleteApiChat(1,2)"><?php echo p__("Migachat", 'Delete only chat history keeping first interaction');?></button>
        </div>
    </div>
    <div id="app_delete_all_chat_history_update_prompt" class="app_delete_all_chat_history_update_prompt">
        <div class="app_delete_all_chat_history_update_prompt-content">
            <span class="button btn btn-red color-red pull-right"
                id="close-app_delete_all_chat_history_update_prompt"><b>X</b></span>
            <div class="app_delete_all_chat_history_update_prompt-header"><?php echo p__("Migachat", 'Confirm Deletion');?></div>
            <div class="app_delete_all_chat_history_update_prompt-textarea">
                <p><?php echo P__("Migachat", 'If you have modified a part of the existing prompt and this part changes considerably compared to before, then it is a good idea to delete the history of saved chats. However, if you have added information to the prompt that was not present before, we recommend that you do not delete anything. What do you want to do?')?>
                </p>
            </div>
            <button class="button btn btn color-blue pull-right"
                id="app_delete_all_chat_history_update_prompt_no"><?php echo p__("Migachat", 'No, do not delete');?></button>
            <button class="button btn btn-warning color-yellow pull-left"
                id="app_delete_all_chat_history_update_prompt_chat"
                onclick="deleteChatAfterPromptUpdate()"><?php echo p__("Migachat", 'Delete history');?></button>
        </div>
    </div>

    <div id="system-prompt-popup" class="system-prompt-popup">
        <div class="system-prompt-popup-content">
            <span class="button btn btn-red color-red pull-right" id="close-system-prompt-popup"><b>X</b></span>
            <div class="system-prompt-popup-header"><?php echo p__("Migachat", 'Please validate the optimized system prompt');?>
            </div>
            <div class="system-prompt-popup-textarea">
                <label for="message"><?php echo p__("Migachat", 'Optimized System Prompt');?>:</label>
                <textarea class="input-flat" id="system-prompt-message" rows="15" cols="40"></textarea>
            </div>
            <button class="button btn btn color-blue pull-right"
                id="system-prompt-confirm"><?php echo p__("Migachat", 'Save new prompt');?></button>
            <button class="button btn btn-warning color-yellow pull-left"
                id="system-prompt-decline"><?php echo p__("Migachat", 'Keep existing prompt');?></button>
        </div>
    </div>
    <div id="log_details-popup" class="log_details-popup">
        <div class="log_details-popup-content">
            <span class="button btn btn-red color-red pull-right" id="close-log_details-popup"><b>X</b></span>
            <div class="log_details-popup-header"><?php echo p__("Migachat", 'Log Details');?></div>
            <div class="log_details-popup-textarea">

            </div>
        </div>
    </div>
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
    <link rel="stylesheet"
        href="<?php echo $this->getUrl("/app/local/modules") . '/Migachat/resources/design/desktop/flat/DataTables/'; ?>datatables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet"
        href="<?php echo $this->getUrl("/app/local/modules") . '/Migachat/resources/design/desktop/flat/DataTables/Buttons/css/'; ?>buttons.dataTables.min.css">
    <link rel="stylesheet"
        href="/app/local/modules/Migachat/resources/design/desktop/flat/template/migachat/application/edit.css">
    <script
        src="<?php echo $this->getUrl("/app/local/modules") . '/Migachat/resources/design/desktop/flat/DataTables/'; ?>datatables.min.js"></script>
    <script
        src="<?php echo $this->getUrl("/app/local/modules") . '/Migachat/resources/design/desktop/flat/DataTables/Buttons/js/'; ?>dataTables.buttons.min.js"></script>
    <script
        src="<?php echo $this->getUrl("/app/local/modules") . '/Migachat/resources/design/desktop/flat/DataTables/Buttons/js/'; ?>buttons.html5.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <script type="text/javascript"
        src="/app/local/modules/Migachat/resources/design/desktop/flat/template/migachat/application/edit.js"> </script>
    <script type="text/javascript"
        src="/app/local/modules/Migachat/resources/design/desktop/flat/template/migachat/application/bridge.js"> </script>
    <script>
        $(document).ready(function () {
            var table = $('#received_table').DataTable({});
            var table2 = $('#not_sent_table').DataTable({});
            var table2 = $('#push_logs_table').DataTable({});

        });

        $(document).ready(function () {
            setTimeout(function () {
                $('.select2').select2();
            }, 5000); // 5000 milliseconds = 5 seconds
        });
        

    </script>
<?php } else {?>
<?php if (! $license['is_platform']) {?>
        <div class="alert alert-info">
            <?php echo $license['info_message']; ?>
        </div>
    <?php }?>
    <div id="migachat" class="module-migachat">
        <div class="navbar-btn btn-sm"></div>
        <ul class="nav nav-tabs custome_nav" role="tablist">
            <li role="presentation" class="active">
                <a href="#tab_license" aria-controls="tab_license" role="tab" data-toggle="tab">
                    <?php echo p__("Migachat", 'License'); ?>
                </a>
            </li>
        </ul>
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="tab_license">
                <h3 class="title-editor no-border-radius title-feature-indent">
                    <?php echo p__("Migachat", 'License'); ?>
                </h3>
                <div class="container-fluid content-feature pt30">
                    <form id="appLicenseForm"
                        action="<?php echo $this->getUrl('migachat/public_license/saveapplicense'); ?>">
                        <input type="hidden" name="value_id" value="<?php echo $option_value->getId(); ?>" />
                        <input type="hidden" name="app_id" value="<?php echo $app_id; ?>" />
                        <div class="form-horizontal">
                            <div class="form-group">
                                <div class="col-md-6">
                                    <label for="key">
                                        <?php echo p__("Migachat", "Your Module License Key") ?>
                                    </label>
                                    <input type="text" id="key" name="key" class="input-flat"
                                        placeholder="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX" />
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-12">
                                    <button class="button btn bt_save btn color-blue" type="submit">
                                        <?php echo p__("Migachat", 'Save'); ?>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- licences -->
    <script>
        $(document).ready(function () {
            page.setCallback('didappear', function () {
                $('#appLicenseForm').submit(function () {
                    reload(this, this.action, true, function (data) {
                        page.reload();
                    });
                    return false;
                });
            });
            page.setCallback('willdisappear', function () {
                $('#appLicenseForm').unbind('submit');
            });
        });
    </script>

    <style type="text/css" media="screen">
        .pt30 {
            padding-top: 30px;
        }
    </style>

<?php }
    } catch (Exception $e) {
        echo "<pre>";
        print_r($app_setting_obj->getId());
        print_r($e->getMessage());
        print_r($e);
    }
?>
